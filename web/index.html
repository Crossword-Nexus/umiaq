
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umiaq Solver</title>
  <!-- Word list processing -->
  <script src="./word-list.js" type="text/javascript"></script>
  <!-- Styles -->
  <link rel="stylesheet" href="./skeleton.min.css" />
  <link rel="stylesheet" href="./umiaq.css" />
  <!-- Render README -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- monospace font -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
</head>
<body>
  <!-- modal box placeholder -->
  <div class="cw-modal" id="cw-modal"></div>
  <h1>Umiaq</h1>
  <div id="loading"><span id="spinner"></span>Loading ...</div>

  <div id="mainUI">
    <form>
      <label class="label">
        <span class="label-text">Pattern:</span>
        <input class="input" id="input" type="text" />
      </label>

      <label for="numResults">Number of results</label>
      <select id="numResults">
        <option value="100">100</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
      </select>

      <br />

      <button class="button-primary" type="submit">Search</button>
    </form>

    <button type="submit" id="word-list-button" value="Upload word list">(Optional) Upload word list</button>

    <div id="results"></div>
    <div id="results-meta"></div>

    <div id="examples-container"></div>

    <!-- Readme -->
    <details style="margin-top:2em;">
      <summary>Show README</summary>
      <div id="readme"></div>
    </details>

    <script>
    fetch('./README.md')
      .then(r => r.text())
      .then(md => {
        document.getElementById('readme').innerHTML = marked.parse(md);
      });
    </script>

  </div>

  <p>
    <a href="https://www.youtube.com/watch?v=cZzTHqe1n-w" target="_blank">how-to video</a>
     •
     <a href="https://github.com/Crossword-Nexus/umiaq" target="_blank">source code</a>
  </p>

  <script type="module">
    // load and process the default word list
    import init, { parse_word_list } from './pkg/umiaq.js';

    async function getLocalWordList() {
      const url = './data/spreadthewordlist.dict';
      const minScore = 50;
      await init(); // ensure WASM is loaded
      window.parse_word_list = parse_word_list; // make it available to classic scripts

      try {
        const resp = await fetch(url, { cache: 'no-cache' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();

        // Call into Rust instead of JS parsing:
        window.word_list = parse_word_list(text, minScore); // returns a JS Array<string>
      } catch (err) {
        console.error(err);
        alert(`Could not load "${url}". Check the path and CORS/MIME type.`);
      }
    }

    await getLocalWordList();

    // Set up the web worker
    const worker = new Worker(new URL('./solver.worker.js', import.meta.url), { type: 'module' });

    // Define elements
    const resultsEl = document.getElementById("results");
    const inputEl = document.getElementById("input");

    worker.postMessage({ type: 'init' });
    worker.onmessage = (e) => {
      if (e.data.type === 'ready') {
        // Hide and show
        document.getElementById("loading").style.display = "none";
        document.getElementById("mainUI").style.display = "block";
      } else if (e.data.type === 'ok') {
        const rows = e.data.results['solutions'];
        const status = e.data.results['status'];
        resultsEl.textContent = rows.map(r => r.join(' • ').toUpperCase()).join('\n') || 'No matches found.';

        if (searchStart !== null) {
          const elapsed = ((performance.now() - searchStart) / 1000).toFixed(2);
          const count = rows.length;
          let meta = `${count} result${count !== 1 ? 's' : ''} loaded in ${elapsed} seconds.`;
          if (status === 'timed_out') {
            meta += "\n⚠️ Solver timed out. Results may be incomplete. ⚠️";
          } else if (status === 'found_enough') {
            meta += `\nSearch terminated after finding the requested number of results.`;
          }
          document.getElementById("results-meta").textContent = meta;
        }

      } else if (e.data.type === 'err') {
        resultsEl.textContent = 'Error: ' + e.data.error;
      }
    };

    // For timing
    let searchStart = null;

    async function solve(e) {
      e.preventDefault();
      resultsEl.htmlContent = '<span id="spinner"></span> Loading …';
      document.getElementById("results-meta").textContent = '';
      // the "numResults" element
      const numResultsEl = document.getElementById('numResults');
      searchStart = performance.now();   // mark start time
      worker.postMessage({
        type: 'solve',
        input: inputEl.value.trim(),
        wordList: window.word_list,
        numResults: parseInt(numResultsEl.value),
      });
    }

    // Add listener to "submit" button
    document.querySelector("form").addEventListener("submit", solve);

  </script>

  <script>
    // Load the examples
    fetch("./examples.html")
      .then(response => response.text())
      .then(html => {
        document.getElementById("examples-container").innerHTML = html;
      });
    // attach listener
    document.getElementById('word-list-button').addEventListener('click', createWordListModal);
  </script>

</body>
</html>
